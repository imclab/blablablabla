var gapminder={data_manager:{},viz:{},tools:{},graphics:{}};gapminder.debug=!1,gapminder.viz.time_slider=function(t){var e={},n={},a={start:1800,current:1800,end:2100},i={play_button:{},pause_button:{},moveable_button:{}},r={},o=function(t){e=d3.select(t.div),n=e.append("svg").attr("height",e.attr("height")).attr("width",e.attr("width")),a.start=+t.start||a.start,a.end=+t.end||a.end,a.current=+t.current||a.start,r=d3.time.scale().range([60,250]).domain([new Date(a.start,0),new Date(a.end,0)]).clamp(!0),c(),l(),u(),s(),d()},c=function(){d3.time.format("%Y").parse;var t=[new Date(a.start,0),new Date(a.start+(a.end-a.start)/2,0),new Date(a.end,0)],e=d3.svg.axis().scale(r).tickValues(t).tickSize(15,0,2).tickPadding(11).tickSubdivide(1).tickFormat(function(t){return t.getFullYear()});n.append("g").attr("class","timeline").attr("transform","translate(0,40)").call(e)},l=function(){var t=n.append("g").attr("class","play_button");t.append("circle").attr("r",18.032).attr("cx",19.032).attr("cy",19.032),t.append("path").attr("d",gapminder.graphics.time_slider.play_triangle),t.attr("transform","translate(0, 18)").attr("visibility","visible"),i.play_button=t},u=function(){var t=n.append("g").attr("class","pause_button");t.append("circle").attr("r",18.032).attr("cx",19.032).attr("cy",19.032),t.append("path").attr("d",gapminder.graphics.time_slider.pause_bar1),t.append("path").attr("d",gapminder.graphics.time_slider.pause_bar2),t.attr("transform","translate(0, 18)").attr("visibility","hidden"),i.pause_button=t},s=function(){var t=n.append("g").attr("class","moveable_button");t.append("path").attr("stroke-miterlimit",10).attr("d",gapminder.graphics.time_slider.move_button),t.append("rect").attr("x",8.146993).attr("y",9.002818).attr("width",2.985586).attr("height",12.574781),t.append("rect").attr("x",12.77933).attr("y",9.002818).attr("width",2.985586).attr("height",12.574781),t.attr("transform","translate(48, 25)"),i.moveable_button=t},d=function(){var t=n.selectAll(".time_slider_year").data([a.current],function(t){return t});t.enter().append("text").attr("class","time_slider_year").attr("x",155).attr("y",30).text(function(){return Math.floor(a.current)}),t.exit().remove()},m=function(){d()};return o(t),{buttons:i,time:a,update:m,timeline_x:r}},gapminder.graphics.time_slider={move_button:"m22.881718,10.764284c-0.475458,-5.471561 -5.19836,-9.764284 -10.792168,-9.764284c-5.605913,0 -10.58994,4.309327 -11.048798,9.799001c-0.040752,0.315464 0.006039,0.636966 0.006039,0.964504l0,8.97638c0,4.928179 5.512316,10.285027 10.857103,14.280397c4.802883,-3.368973 11.000465,-9.352219 11.000465,-14.280397l0,-8.97638c0,-0.338104 0.02264,-0.670172 -0.022642,-0.999221z",play_triangle:"m16.104044,9.928802c-0.298447,-0.136328 -0.72585,-0.38319 -1.063597,-0.394244c-0.729534,0.046671 -1.408713,0.637422 -1.408713,1.375551l0,16.248697c0,0.731989 0.670582,1.316599 1.390289,1.36941c0.346345,-0.006142 0.693916,-0.20756 1.007102,-0.40284l13.194235,-8.11084c0.622681,-0.404068 0.655842,-1.509418 0.01351,-1.968756l-13.132826,-8.116979z",pause_bar1:"m17.071117,27.009705c0,0.817007 -0.661329,1.479578 -1.47958,1.479578l-1.728666,0c-0.818252,0 -1.479578,-0.662571 -1.479578,-1.479578l0,-15.991412c0,-0.817004 0.661326,-1.479578 1.479578,-1.479578l1.728666,0c0.817009,0 1.47958,0.662574 1.47958,1.479578l0,15.991412z",pause_bar2:"m25.644701,27.009705c0,0.817007 -0.662569,1.479578 -1.479576,1.479578l-1.728666,0c-0.818253,0 -1.47958,-0.662571 -1.47958,-1.479578l0,-15.991412c0,-0.817004 0.660082,-1.479578 1.47958,-1.479578l1.728666,0c0.817007,0 1.479576,0.662574 1.479576,1.479578l0,15.991412z"},gapminder.tools.time_slider=function(t){"use strict";var e,n={height:80,width:270,play_interval:10,time_slash:.1,time_precision:5,playing:!1,sliding:!1},a={},i={},r={},o=function(t){a=gapminder.viz.time_slider(t),i=a.buttons,r=a.time,d(),m(),p()},c=function(t){"hidden"===t.attr("visibility")?t.attr("visibility","visible"):t.attr("visibility","hidden")},l=function(){d3.scale.linear().range([0,190]).domain([60,250]).clamp(!0),d3.scale.linear().range([r.start,r.end]).domain([60,250]).clamp(!0),i.moveable_button.attr("transform","translate("+(-12+a.timeline_x(new Date(r.current,0)))+", 25)")},u=function(t){n.time_slash=+t,n.time_precision=n.time_slash<1?4+(n.time_slash%1).toString().length-2:0===4+n.time_slash%1?+n.time_slash.toString().length:n.time_slash.toString().length-1},s=function(t){n.playing?(r.current+n.time_slash<=r.end&&(r.current+=n.time_slash,r.current=+r.current.toPrecision(n.time_precision)),a.update(),l()):(c(i.play_button),c(i.pause_button),clearInterval(e)),"function"==typeof t&&t(r.current)},d=function(t){i.play_button.on("mouseup",function(){n.playing=!0,c(i.play_button),c(i.pause_button),e=setInterval(s,n.play_interval,t)})},m=function(t){i.pause_button.on("mouseup",function(){n.playing=!1,c(i.play_button),c(i.pause_button),clearInterval(e),"function"==typeof t&&t(r.current)})},p=function(t){var e=d3.scale.linear().range([0,190]).domain([60,250]).clamp(!0);d3.scale.linear().range([r.start,r.end]).domain([60,250]).clamp(!0),i.moveable_button.on("mousedown",function(){n.sliding=!0}),window.addEventListener("mousemove",function(){n.sliding&&(n.playing&&(n.playing=!1),i.moveable_button.attr("transform","translate("+(48+e(event.pageX))+", 25)"),r.current=a.timeline_x.invert(60+e(event.pageX)).getFullYear(),console.log(i.moveable_button.clientLeft),a.update(),"function"==typeof t&&t(r.current))}),window.addEventListener("mouseup",function(){n.sliding=!1})};o(t);var g=function(){console.log(n)};return{time:r,set_time_slash:u,on_play:d,on_stop:m,on_slide:p,debug:g}},gapminder.data_manager.income_mountain=function(){"use strict";var t={},e="data/",n=".csv",a=function(t,a){d3.csv(e+t+n,function(t){"function"==typeof a&&a(t)})},i=function(e,n){for(var i={},o=0;o<e.length;o++)t[e[o]]?i[e[o]]=t[e[o]]:function(e){a(e,function(a){t[e]=r(a),i[e]=t[e],"function"==typeof n&&n(a,o)})}(e[o]);return i},r=function(t){var e=0,n=d3.nest().key(function(t){return t.year}).rollup(function(t){var n=[],a=0;return t.forEach(function(t){a=Math.max(a,t.height),n.push({height:Number(t.height),x:Number(t.x),y:Number(t.height),y0:0})}),n.year_max_height=a,e=Math.max(e,a),n}).map(t);return n.geo_max_height=e,n};return{load:i}},gapminder.viz.income_mountain=function(t){"use strict";var e={},n={},a=500,i=900,r=function(t){return gapminder.debug&&console.debug("gapminder.viz.income_mountain: init(): properties",t),e=d3.select(t.div),e.empty()?(console.error("You should pass a valid div id!"),void 0):(a=Number(t.height)||a,i=Number(t.width)||i,n=e.append("svg").attr("class","mountains").attr("height",a).attr("width",i),void 0)},o=function(t){if(t&&t.data){var e=t.name||(1e3*Math.random()).toString,a=t.color||"orange";t.data;var i=n.append("g").attr("id",e+"-income-mountain").selectAll("path").data(t.data);i.enter().append("path").attr("fill",a).attr("d",l)}},c=function(){n.selectAll("g").remove()},l=function(t){return d3.svg.area().interpolate("basis").x(function(t){return u(Math.exp(t.x))}).y0(function(t){return a-t.y0}).y1(function(t){return a-(t.y0+t.y)})(t)},u=function(t){return d3.scale.log().domain([182.5,152e3]).range([10,i-10]).clamp(!0)(t)};return r(t),{show:o,clear:c}},gapminder.viz.income_mountain.labels=function(t){"use strict";var e={},n=[],a=function(){},i=function(t){e=d3.select(t.div).append("div").style("width","200px").style("height","300px").style("position","absolute").attr("id","labels"),n=t.geo},r=function(){for(var t=n.length,a=0;t>a;a++){var i=e.append("text").html(n[a]);i.append("div").style("display","inline-block").style("width","10px").style("height","10px").style("background-color","blue").style("color","white").style("font-size","10px").on("click",function(){u(n[a])}),i.append("text").html("<br>")}},o=function(){},c=function(){e.selectAll("div").remove(),e.selectAll("text").remove()},l=function(t){n=t,c(),r()},u=function(t){a(t)},s=function(t){"function"==typeof t&&(a=t)},d=function(){console.log(e)};return i(t),d(),r(),{debug:d,show:r,hide:o,update:l,set_on_click:s}},gapminder.income_mountain=function(t){"use strict";var e={},n=[],a=!1,i={command_queue:[],maximum_height:0,first_year:1820,final_year:2010,year:1820,active_geo:[],height:500,width:900,stacked:!1,play:!1},r={},o={},c={},l={},u=function(t){i.first_year=t.start_year||i.first_year,i.final_year=t.final_year||i.final_year,i.year=t.year||i.year,i.width=t.width||i.width,i.height=t.height||i.height,i.stacked=t.stack||i.stacked,"object"==typeof t.geo&&t.geo.length?i.active_geo=t.geo:"string"==typeof t.geo&&(i.active_geo=t.geo.split(",")),m(),l=gapminder.viz.income_mountain.labels({div:t.div,geo:i.active_geo}),console.log(l.on_click),l.set_on_click(function(t){alert(t)}),r=gapminder.viz.income_mountain({div:t.div,width:i.width,height:i.height}),o=gapminder.data_manager.income_mountain();var n=1e3*Math.random().toPrecision(3);d3.select(t.div).append("div").attr("id","time-slider"+n).style("width","270px").style("height","80px"),c=gapminder.tools.time_slider({div:"#time-slider"+n,start:i.first_year,end:i.final_year}),c.on_play(function(t){i.year=t,p()}),c.on_stop(function(t){i.year=t,p()}),c.on_slide(function(t){i.year=t,p()});var u=i.active_geo.length;e=o.load(i.active_geo,function(){u-=1,0===u&&(a=!0,p(),v())})},s=function(t){-1===i.active_geo.indexOf(t)&&(a=!1,i.active_geo.push(t),e=o.load(i.active_geo,function(){a=!0,p(),l.update(i.active_geo),v()}))},d=function(t,e){i.active_geo.splice(i.active_geo.indexOf(t),1),"function"==typeof e&&e()},m=function(){i.active_geo=i.active_geo.filter(function(t,e,n){return n.indexOf(t)==e})},p=function(){if(a){g(),f(),r.clear();for(var t=0;t<n.length;t++)h(n[t].data),r.show({name:n[t].name,data:[n[t].data],color:n[t].color})}},g=function(){for(var t=[],a=Math.floor(i.year),r=0;r<i.active_geo.length;r++){var o=i.active_geo[r];e[o]&&e[o][a]&&(_(o,e[o][a]),t.push({name:o,data:e[o][a],color:"blue",geo_max_height:e[o].geo_max_height}))}n=t},h=function(t){for(var e=0;e<t.length;e++)t[e].y=i.height/i.maximum_height*t[e].y},f=function(){i.maximum_height=0;for(var t in e)e.hasOwnProperty(t)&&(i.maximum_height=Math.max(i.maximum_height,e[t].geo_max_height))},_=function(t,n){var a=Math.ceil(i.year),r=i.year%1;if(e[t][a])for(var o=e[t][a],c=0;c<n.length;c++){var l=o[c].height-n[c].height;n[c].y=n[c].height+l*r}},v=function(){for(var t=0;t<i.command_queue.length;t++)i.command_queue[t](),i.command_queue.unshift()},y=function x(t,e){return a?(t>=i.first_year&&t<=i.final_year&&(i.year=t,"function"==typeof e&&e()),void 0):(i.command_queue.push(b(x,this,[t,e])),void 0)},b=function(t,e,n){return function(){t.apply(e,n)}};return u(t),{add:s,remove:d,update:y,draw:p}};